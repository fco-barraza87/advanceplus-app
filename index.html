<script type="module">
import { supabase } from "/js/supabase.js";

/* --------------------------
   TABS LOGIN / REGISTER
--------------------------- */
const tabLogin = document.getElementById("tabLogin");
const tabRegister = document.getElementById("tabRegister");
const loginForm = document.getElementById("loginForm");
const registerForm = document.getElementById("registerForm");

tabLogin.onclick = () => {
  tabLogin.classList.add("active");
  tabRegister.classList.remove("active");
  loginForm.classList.add("active");
  registerForm.classList.remove("active");
};

tabRegister.onclick = () => {
  tabRegister.classList.add("active");
  tabLogin.classList.remove("active");
  registerForm.classList.add("active");
  loginForm.classList.remove("active");
};

/* --------------------------
   LOGIN
--------------------------- */
loginForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  const email = document.getElementById("loginEmail").value.trim();
  const password = document.getElementById("loginPassword").value.trim();
  const err = document.getElementById("loginError");

  err.textContent = "";

  const { error } = await supabase.auth.signInWithPassword({ email, password });

  if (error) {
    err.textContent = "Credenciales incorrectas";
    return;
  }

  window.location.href = "/dashboard/index.html";
});

/* --------------------------
   REGISTER
--------------------------- */
registerForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  const name = document.getElementById("regName").value.trim();
  const email = document.getElementById("regEmail").value.trim();
  const password = document.getElementById("regPassword").value.trim();
  const err = document.getElementById("regError");

  err.textContent = "";

  // 1) Crear usuario
  const { data, error } = await supabase.auth.signUp({
    email,
    password,
    options: { data: { full_name: name } }
  });

  if (error) {
    err.textContent = error.message;
    return;
  }

  // 2) Intentar obtener la sesión
  let user = data.user;

  if (!user) {
    const retry = await supabase.auth.getUser();
    user = retry.data.user;
  }

  if (!user) {
    err.textContent = "Error al iniciar sesión automáticamente.";
    return;
  }

  // 3) Buscar curso-bienvenida
  const { data: course } = await supabase
    .from("courses")
    .select("id, slug")
    .eq("slug", "curso-bienvenida")
    .single();

  // 4) Asignar curso
  if (course) {
    await supabase
      .from("user_courses")
      .insert({
        user_id: user.id,
        course_id: course.id,
        status: "active"
      })
      .catch(() => {});
  }

  // 5) Ir al dashboard
  window.location.href = "/dashboard/index.html";
});

/* --------------------------
   RESET PASSWORD
--------------------------- */
const resetModal = document.getElementById("resetModal");

document.getElementById("openReset").onclick = () =>
  resetModal.classList.remove("hidden");

document.getElementById("resetClose").onclick = () =>
  resetModal.classList.add("hidden");

document.getElementById("resetSend").onclick = async () => {
  const email = document.getElementById("resetEmail").value.trim();
  const msg = document.getElementById("resetMsg");

  const { error } = await supabase.auth.resetPasswordForEmail(email);

  msg.textContent = error ? "Error enviando correo" : "Correo enviado";
};
</script>
